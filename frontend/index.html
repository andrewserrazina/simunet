<!doctype html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SimuNet • Dashboard</title>
  <link rel="icon" href="/favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    :root{ --glass: 255,255,255,0.06; }
    .grad { background: linear-gradient(135deg, #2e6af6, #7b5cff); }
    .tile-dark img.leaflet-tile { filter: invert(1) hue-rotate(180deg) brightness(.95) contrast(.95); }
  </style>
</head>
<body class="bg-[#0b1020] text-slate-100">
  <div class="min-h-screen grid md:grid-cols-[280px_1fr]">
    <aside class="hidden md:flex flex-col gap-4 p-4 bg-[#0a0f25]/95 border-r border-white/10">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl grad grid place-items-center font-black">S</div>
        <div><div class="font-bold text-lg">SimuNet</div><div class="text-xs text-slate-400">Drive • Fly • Deliver</div></div>
      </div>
      <nav class="mt-4 flex-1 flex flex-col">
        <a class="flex items-center gap-2 px-3 py-2 rounded-lg bg-white/10 text-white" href="#"><i data-lucide="layout-dashboard" class="w-4 h-4"></i> Dashboard</a>
        <a class="flex items-center gap-2 px-3 py-2 rounded-lg text-slate-300 hover:bg-white/10" href="#"><i data-lucide="plane" class="w-4 h-4"></i> Flights</a>
        <a class="flex items-center gap-2 px-3 py-2 rounded-lg text-slate-300 hover:bg-white/10" href="#"><i data-lucide="radio" class="w-4 h-4"></i> Connectors</a>
        <a class="flex items-center gap-2 px-3 py-2 rounded-lg text-slate-300 hover:bg-white/10" href="#"><i data-lucide="book-open" class="w-4 h-4"></i> Docs</a>
      </nav>
      <div class="mt-auto text-xs text-slate-400">v1.0 • Neon-ready</div>
    </aside>

    <div class="flex flex-col">
      <header class="flex items-center gap-3 p-3 md:p-4 border-b border-white/10 bg-[#0f1430]/90 sticky top-0 z-10">
        <div class="hidden md:flex items-center gap-2">
          <span class="text-xs px-2 py-1 border border-white/10 rounded-full text-slate-300">API</span>
          <input id="api" class="px-3 py-2 w-[320px] rounded-lg bg-[#0f1538] border border-white/10 text-sm" placeholder="https://your-api.onrender.com" />
          <button id="btnPing" class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/15 text-sm">Ping</button>
          <span id="dbStatus" class="text-xs px-2 py-1 rounded-full border border-white/10 text-slate-300">db?</span>
          <span id="apiStatus" class="text-xs px-2 py-1 rounded-full border border-white/10 text-slate-300">api?</span>
        </div>
        <div class="ml-auto flex items-center gap-3">
          <button id="themeToggle" class="p-2 rounded-lg bg-white/10" title="Toggle theme"><i data-lucide="sun"></i></button>
          <div class="flex items-center gap-2 px-2 py-1 rounded-lg bg-white/10">
            <div class="w-6 h-6 rounded-full grad grid place-items-center text-xs font-bold">A</div>
            <div class="hidden sm:block text-xs text-slate-300">Logged in</div>
          </div>
        </div>
      </header>

      <main class="p-3 md:p-6 space-y-6">
        <section class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="border border-white/10 rounded-2xl p-4 bg-[#0f1430]">
            <div class="text-slate-300 text-sm">Active Flights</div>
            <div class="text-2xl font-bold mt-1"><span id="kpiFlights">0</span></div>
          </div>
          <div class="border border-white/10 rounded-2xl p-4 bg-[#0f1430]">
            <div class="text-slate-300 text-sm">Telemetry Points</div>
            <div class="text-2xl font-bold mt-1"><span id="kpiPoints">0</span></div>
          </div>
          <div class="border border-white/10 rounded-2xl p-4 bg-[#0f1430]">
            <div class="text-slate-300 text-sm">Database</div>
            <div class="text-2xl font-bold mt-1"><span id="kpiDb">offline</span></div>
          </div>
          <div class="border border-white/10 rounded-2xl p-4 bg-[#0f1430]">
            <div class="text-slate-300 text-sm">API</div>
            <div class="text-2xl font-bold mt-1"><span id="kpiApi">unknown</span></div>
          </div>
        </section>

        <section class="grid lg:grid-cols-[1.6fr_1fr] gap-4">
          <div class="space-y-4">
            <div class="border border-white/10 rounded-2xl bg-[#0f1430] p-4">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold">Live Map</h3>
                <div class="text-xs text-slate-400" id="status">Ready.</div>
              </div>
              <div id="map" class="h-[440px] rounded-lg overflow-hidden tile-dark"></div>
            </div>
            <div class="border border-white/10 rounded-2xl bg-[#0f1430] p-4">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold">Altitude (k-index)</h3>
                <div class="text-xs text-slate-400" id="chartMeta">—</div>
              </div>
              <canvas id="altChart" height="160"></canvas>
            </div>
          </div>

          <div class="space-y-4">
            <div class="border border-white/10 rounded-2xl bg-[#0f1430] p-4">
              <h3 class="font-semibold mb-3">Quick Actions</h3>
              <div class="space-y-3">
                <div class="flex gap-2">
                  <input id="flightId" class="flex-1 px-3 py-2 rounded-lg bg-[#0f1538] border border-white/10 text-sm" placeholder="flight_id" />
                  <button id="btnCopy" class="px-3 py-2 rounded-lg bg-white/10">Copy</button>
                </div>
                <div class="grid grid-cols-2 gap-2">
                  <button id="btnSeed" class="px-3 py-2 rounded-lg grad">Seed & Start</button>
                  <button id="btnLoad" class="px-3 py-2 rounded-lg bg-white/10">Load & Animate</button>
                  <button id="btnDemo" class="px-3 py-2 rounded-lg bg-white/10 col-span-2">Start Demo Stream</button>
                </div>
                <p class="text-xs text-slate-400">Tip: Pass <code>?api=https://your-api.onrender.com</code> in the URL to preset the API.</p>
              </div>
            </div>

            <div class="border border-white/10 rounded-2xl bg-[#0f1430] p-4">
              <h3 class="font-semibold mb-3">Recent Flights</h3>
              <div class="overflow-auto">
                <table class="w-full text-sm">
                  <thead class="text-left text-slate-300">
                    <tr><th class="py-2">Flight ID</th><th class="py-2">Points</th><th class="py-2">Last Used</th></tr>
                  </thead>
                  <tbody id="recentTable" class="text-slate-400"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    lucide.createIcons();
    document.getElementById('themeToggle').addEventListener('click', ()=> document.documentElement.classList.toggle('dark'));

    const ls = window.localStorage;
    const qsApi = new URLSearchParams(location.search).get('api');
    const apiInput = document.getElementById('api');
    const detected = (location.origin.includes('localhost') || location.protocol==='file:') ? 'http://localhost:8000' : location.origin;
    apiInput.value = qsApi || ls.getItem('simunet_api') || detected;
    apiInput.addEventListener('change', ()=> ls.setItem('simunet_api', apiInput.value.trim()));

    const map = L.map('map', { zoomControl: true }).setView([39.5,-98.35], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
    const pathLine = L.polyline([], { weight: 3, opacity: .95 }).addTo(map);
    const marker = L.circleMarker([0,0], { radius: 6, weight: 2 }).addTo(map);

    const statusEl = document.getElementById('status');
    const kpiFlights = document.getElementById('kpiFlights');
    const kpiPoints  = document.getElementById('kpiPoints');
    const kpiDb      = document.getElementById('kpiDb');
    const kpiApi     = document.getElementById('kpiApi');
    const dbStatus   = document.getElementById('dbStatus');
    const apiStatus  = document.getElementById('apiStatus');
    const flightIdEl = document.getElementById('flightId');
    const recentTable = document.getElementById('recentTable');
    const chartMeta = document.getElementById('chartMeta');

    function setBadge(el, text, cls){
      el.textContent = text;
      el.className = 'text-xs px-2 py-1 rounded-full border ' + (cls || 'border-white/10 text-slate-300');
    }
    function fmtDate(n){ const d = new Date(n); return d.toLocaleString(); }

    function saveRecent(fid, count){
      const rec = JSON.parse(ls.getItem('simunet_recent') || '[]');
      const now = Date.now();
      const idx = rec.findIndex(r => r.flight_id === fid);
      if(idx>=0){ rec[idx] = { flight_id: fid, points: count, used_at: now }; }
      else { rec.unshift({ flight_id: fid, points: count, used_at: now }); }
      ls.setItem('simunet_recent', JSON.stringify(rec.slice(0,25)));
      renderRecent();
    }
    function renderRecent(){
      const rec = JSON.parse(ls.getItem('simunet_recent') || '[]');
      recentTable.innerHTML = '';
      rec.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td class="py-2"><button class="underline hover:text-slate-200" data-fid="'+r.flight_id+'">'+r.flight_id+'</button></td>' +
                       '<td class="py-2 text-slate-300">'+(r.points||0)+'</td>' +
                       '<td class="py-2">'+fmtDate(r.used_at)+'</td>';
        tr.querySelector('button').onclick = (e)=> { flightIdEl.value = e.target.dataset.fid; };
        recentTable.appendChild(tr);
      });
      kpiFlights.textContent = rec.length;
    }
    renderRecent();

    async function apiFetch(path, opts){
      const api = apiInput.value.trim().replace(/\/$/, '');
      const r = await fetch(api + path, opts);
      if (!r.ok) throw new Error((await r.text()) || ('HTTP ' + r.status));
      return r.json();
    }

    document.getElementById('btnPing').addEventListener('click', async ()=>{
      setBadge(apiStatus, 'checking...', 'border-white/10 text-slate-400');
      try{
        const s = await apiFetch('/status');
        kpiDb.textContent = s.db ? 'online' : 'offline';
        setBadge(dbStatus, s.db ? 'db: online' : 'db: offline', s.db ? 'border-emerald-400/40 text-emerald-300' : 'border-amber-400/40 text-amber-300');
        setBadge(apiStatus, 'reachable', 'border-emerald-400/40 text-emerald-300');
        kpiApi.textContent = 'reachable';
        statusEl.textContent = 'OK';
      }catch(e){
        kpiDb.textContent = 'offline';
        setBadge(dbStatus, 'db: error', 'border-rose-400/40 text-rose-300');
        setBadge(apiStatus, 'unreachable', 'border-rose-400/40 text-rose-300');
        kpiApi.textContent = 'unreachable';
        statusEl.textContent = 'API not reachable.';
      }
    });

    document.getElementById('btnCopy').addEventListener('click', async ()=>{
      const fid = flightIdEl.value.trim(); if(!fid) return;
      try{ await navigator.clipboard.writeText(fid);}catch{}
    });

    document.getElementById('btnSeed').addEventListener('click', async ()=>{
      statusEl.textContent = 'Seeding...';
      try{
        const seeded = await apiFetch('/dev/reseed', { method:'POST' });
        const started = await apiFetch('/flights?assignment_id='+encodeURIComponent(seeded.job_id)+'&seq=1&mode=truck', { method:'POST' });
        flightIdEl.value = started.flight_id;
        saveRecent(started.flight_id, 0);
        statusEl.textContent = 'Created flight '+started.flight_id;
      }catch(e){
        console.error(e); statusEl.textContent = 'Seed/start failed.';
      }
    });

    async function fetchTelemetry(fid){
      const data = await apiFetch('/telemetry/'+encodeURIComponent(fid));
      return data.points || [];
    }
    function fitPath(points){
      if(!points.length) return;
      const latlngs = points.map(p => [p.lat, p.lon]);
      map.fitBounds(L.latLngBounds(latlngs), { padding: [20,20] });
    }
    function sleep(ms){ return new Promise(res=>setTimeout(res, ms)); }

    const ctx = document.getElementById('altChart');
    let altChart = new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'Altitude', data: [], tension: 0.3 }]},
      options: { plugins:{ legend:{ labels:{ color:'#cbd5e1' } } }, scales:{ x:{ ticks:{ color:'#cbd5e1' }}, y:{ ticks:{ color:'#cbd5e1' }}} }
    });

    document.getElementById('btnLoad').addEventListener('click', async ()=>{
      const fid = flightIdEl.value.trim(); if(!fid){ alert('Enter a flight_id.'); return; }
      statusEl.textContent = 'Loading telemetry...';
      try{
        const pts = await fetchTelemetry(fid);
        kpiPoints.textContent = pts.length;
        saveRecent(fid, pts.length);
        if(!pts.length){ statusEl.textContent = 'No points yet. Add via Demo Stream or your connector.'; return; }
        const latlngs = pts.map(p => [p.lat, p.lon]);
        pathLine.setLatLngs(latlngs);
        marker.setLatLng(latlngs[latlngs.length-1]);
        fitPath(pts);
        altChart.data.labels = pts.map(p => p.k);
        altChart.data.datasets[0].data = pts.map(p => p.alt || 0);
        altChart.update();
        document.getElementById('chartMeta').textContent = pts.length+' points • last k='+pts[pts.length-1].k;
        for(const p of pts){ marker.setLatLng([p.lat, p.lon]); await sleep(110); }
        statusEl.textContent = 'Rendered '+pts.length+' points.';
      }catch(e){ console.error(e); statusEl.textContent = 'Load failed.'; }
    });

    document.getElementById('btnDemo').addEventListener('click', async ()=>{
      const fid = flightIdEl.value.trim(); if(!fid){ alert('Create or paste a flight_id first.'); return; }
      statusEl.textContent = 'Streaming demo telemetry...';
      try{
        let lat=40.7, lon=-74.0, alt=50;
        for(let k=0; k<80; k++){
          const pt = { flight_id: fid, k, lat, lon, alt, ts: new Date().toISOString() };
          await apiFetch('/telemetry', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(pt)});
          lat += 0.002; lon += 0.004; alt += (k%12===0? 20: 0);
          await sleep(110);
        }
        statusEl.textContent = 'Demo stream complete. Click "Load & Animate".';
      }catch(e){ console.error(e); statusEl.textContent = 'Demo stream failed.'; }
    });

    document.getElementById('btnPing').click();
  </script>
</body>
</html>
