<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SimuNet • Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
:root{
  --bg:#0b1020; --panel:#0f1430; --muted:#1a2147; --border:#1e2656;
  --text:#eaf2ff; --subtext:#a9b6d3; --accent:#2e6af6; --good:#16c47f; --warn:#ffb020; --bad:#ff5c5c;
}
*{box-sizing:border-box}
html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
#shell{ display:grid; grid-template-columns: 260px 1fr; grid-template-rows: 64px 1fr; grid-template-areas: "side top" "side main"; height:100%; }
aside{ grid-area: side; background:linear-gradient(180deg, #0d1430 0%, #0a0f25 100%); border-right:1px solid var(--border); display:flex; flex-direction:column; }
header{ grid-area: top; background:var(--panel); border-bottom:1px solid var(--border); display:flex; align-items:center; gap:12px; padding:10px 16px; }
main{ grid-area: main; padding:16px; overflow:auto; }
.logo{ display:flex; align-items:center; gap:10px; padding:16px; border-bottom:1px solid var(--border); }
.logo-badge{ width:34px; height:34px; border-radius:10px; background:var(--accent); display:grid; place-items:center; font-weight:800; color:white; }
nav a{ display:flex; align-items:center; gap:10px; padding:12px 16px; color:var(--subtext); text-decoration:none; border-left:3px solid transparent; }
nav a:hover{ background:rgba(255,255,255,.03); color:var(--text); }
nav a.active{ color:var(--text); border-left-color:var(--accent); background:rgba(46,106,246,.08); }
.spacer{ flex:1 1 auto; }
.tag{ font-size:12px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; color:var(--subtext); }
input, button, select{ background:#0f1538; border:1px solid var(--border); color:var(--text); padding:8px 10px; border-radius:10px; }
button{ cursor:pointer; background:linear-gradient(180deg, #2e6af6, #2354c2); border:0; }
button.secondary{ background:#0f1538; }
.card{ background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:14px; }
.card h3{ margin:0 0 8px 0; font-size:16px; }
.grid{ display:grid; gap:16px; }
.grid.cols-2{ grid-template-columns: 1.4fr 1fr; }
.grid.cols-3{ grid-template-columns: repeat(3, 1fr); }
.kpi{ display:flex; align-items:center; justify-content:space-between; padding:12px; background:rgba(255,255,255,.02); border:1px dashed var(--border); border-radius:12px; }
.kpi .val{ font-size:20px; font-weight:700; }
small.hint{ color:var(--subtext); }
#map{ height:520px; border-radius:12px; overflow:hidden; }
.leaflet-container{ background:#0b1020; }
.leaflet-tile{ filter: invert(1) hue-rotate(180deg) brightness(0.9) contrast(0.95); }
.table{ width:100%; border-collapse:collapse; font-size:14px; }
.table th, .table td{ padding:8px 6px; border-bottom:1px solid var(--border); color:var(--subtext); }
.table th{ color:var(--text); text-align:left; }
.badge{ padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); }
.badge.good{ color:var(--good); border-color:rgba(22,196,127,.4); background:rgba(22,196,127,.08); }
.badge.warn{ color:var(--warn); border-color:rgba(255,176,32,.4); background:rgba(255,176,32,.08); }
.badge.bad{  color:var(--bad);  border-color:rgba(255,92,92,.4);  background:rgba(255,92,92,.08); }
.row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
.right{ margin-left:auto; }
@media (max-width: 1100px){
  #shell{ grid-template-columns: 1fr; grid-template-rows: 64px auto 1fr; grid-template-areas: "top" "side" "main"; }
  aside{ flex-direction:row; overflow:auto; }
  .logo{ border-bottom:0; border-right:1px solid var(--border); }
  nav{ display:flex; }
  nav a{ border-left:0; border-bottom:3px solid transparent; }
  nav a.active{ border-bottom-color:var(--accent); border-left:0; }
  .grid.cols-2{ grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<div id="shell">
  <aside>
    <div class="logo">
      <div class="logo-badge">S</div>
      <div>
        <div style="font-weight:700">SimuNet</div>
        <div class="tag">Drive • Fly • Deliver</div>
      </div>
    </div>
    <nav>
      <a href="#" class="active">Dashboard</a>
      <a href="#">Flights</a>
      <a href="#">Connectors</a>
      <a href="#">Docs</a>
    </nav>
    <div class="spacer"></div>
    <div style="padding:12px 16px;"><small class="hint">v1.0 • Neon-ready</small></div>
  </aside>

  <header>
    <div class="row">
      <span class="tag">API</span>
      <input id="api" placeholder="https://your-api.onrender.com" style="min-width:320px" />
      <button class="secondary" id="btnPing">Ping</button>
      <span id="dbStatus" class="badge">db?</span>
    </div>
    <div class="right row">
      <input id="flightId" placeholder="flight_id" style="min-width:260px" />
      <button id="btnSeed">Seed & Start</button>
      <button class="secondary" id="btnDemo">Start Demo Stream</button>
      <button class="secondary" id="btnLoad">Load & Animate</button>
    </div>
  </header>

  <main>
    <div class="grid cols-3" style="margin-bottom:16px;">
      <div class="kpi card"><div>Recent Flights</div><div class="val" id="kpiFlights">0</div></div>
      <div class="kpi card"><div>Telemetry Points</div><div class="val" id="kpiPoints">0</div></div>
      <div class="kpi card"><div>DB</div><div class="val" id="kpiDb">offline</div></div>
    </div>

    <div class="grid cols-2">
      <div class="card">
        <h3>Live Map</h3>
        <div id="map"></div>
        <div class="row" style="margin-top:10px">
          <small class="hint" id="status">Ready.</small>
        </div>
      </div>

      <div class="grid" style="grid-auto-rows:min-content;">
        <div class="card">
          <h3>Recent Flight IDs</h3>
          <table class="table" id="recentTable">
            <thead><tr><th>Flight ID</th><th>Points</th><th>Last Used</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="card">
          <h3>Quick Tips</h3>
          <ul style="margin:0 0 0 18px; color:var(--subtext)">
            <li>Click <b>Seed & Start</b> to create a new job & flight.</li>
            <li>Use <b>Start Demo Stream</b> to send telemetry from your browser.</li>
            <li>Front end can target any API — set the <b>API</b> box or append <code>?api=...</code> to the URL.</li>
          </ul>
        </div>
      </div>
    </div>
  </main>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const ls = window.localStorage;
const qsApi = new URLSearchParams(location.search).get('api');
const apiInput = document.getElementById('api');
apiInput.value = qsApi || ls.getItem('simunet_api') || (location.origin.includes('localhost') || location.protocol==='file:' ? 'http://localhost:8000' : location.origin);
apiInput.addEventListener('change', ()=> ls.setItem('simunet_api', apiInput.value.trim()));

const map = L.map('map', { zoomControl: true }).setView([39.5,-98.35], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
const pathLine = L.polyline([], { weight: 3, opacity: .95 }).addTo(map);
const marker = L.circleMarker([0,0], { radius: 6, weight: 2 }).addTo(map);

const statusEl = document.getElementById('status');
const kpiFlights = document.getElementById('kpiFlights');
const kpiPoints  = document.getElementById('kpiPoints');
const kpiDb      = document.getElementById('kpiDb');
const dbStatus   = document.getElementById('dbStatus');
const flightIdEl = document.getElementById('flightId');
const recentTableBody = document.querySelector('#recentTable tbody');

function setBadge(el, state){
  el.className = 'badge ' + (state==='good'?'good':state==='warn'?'warn':state==='bad'?'bad':'');
}
function fmtDate(d){ const x = new Date(d); return x.toLocaleString(); }

function saveRecent(fid, count){
  const rec = JSON.parse(ls.getItem('simunet_recent') || '[]');
  const now = Date.now();
  const idx = rec.findIndex(r => r.flight_id === fid);
  if(idx>=0){ rec[idx] = { flight_id: fid, points: count, used_at: now }; }
  else { rec.unshift({ flight_id: fid, points: count, used_at: now }); }
  ls.setItem('simunet_recent', JSON.stringify(rec.slice(0,20)));
  renderRecent();
}
function renderRecent(){
  const rec = JSON.parse(ls.getItem('simunet_recent') || '[]');
  recentTableBody.innerHTML = '';
  rec.forEach(r=>{
    const tr = document.createElement('tr');
    const a = document.createElement('a'); a.href='#'; a.textContent=r.flight_id; a.onclick=(e)=>{ e.preventDefault(); flightIdEl.value=r.flight_id; };
    const td1 = document.createElement('td'); td1.appendChild(a);
    const td2 = document.createElement('td'); td2.textContent = r.points ?? 0;
    const td3 = document.createElement('td'); td3.textContent = fmtDate(r.used_at);
    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
    recentTableBody.appendChild(tr);
  });
  kpiFlights.textContent = rec.length;
}
renderRecent();

async function apiFetch(path, opts){
  const api = apiInput.value.trim().replace(/\\/$/, '');
  const r = await fetch(api + path, opts);
  if(!r.ok) throw new Error((await r.text()) || ('HTTP '+r.status));
  return r.json();
}

document.getElementById('btnPing').addEventListener('click', async ()=>{
  statusEl.textContent = 'Pinging...';
  try{
    const s = await apiFetch('/status');
    kpiDb.textContent = s.db ? 'online' : 'offline';
    dbStatus.textContent = s.db ? 'db: online' : 'db: offline';
    setBadge(dbStatus, s.db ? 'good' : 'warn');
    statusEl.textContent = 'OK';
  }catch(e){
    kpiDb.textContent = 'offline';
    dbStatus.textContent = 'db: error';
    setBadge(dbStatus, 'bad');
    statusEl.textContent = 'API not reachable.';
  }
});

document.getElementById('btnSeed').addEventListener('click', async ()=>{
  statusEl.textContent = 'Seeding...';
  try{
    const seeded = await apiFetch('/dev/reseed', { method:'POST' });
    const started = await apiFetch(`/flights?assignment_id=${encodeURIComponent(seeded.job_id)}&seq=1&mode=truck`, { method:'POST' });
    flightIdEl.value = started.flight_id;
    saveRecent(started.flight_id, 0);
    statusEl.textContent = `Created flight ${started.flight_id}`;
  }catch(e){
    console.error(e); statusEl.textContent = 'Seed/start failed.';
  }
});

async function fetchTelemetry(fid){
  const data = await apiFetch(`/telemetry/${encodeURIComponent(fid)}`);
  return data.points || [];
}
function fitPath(points){
  if(!points.length) return;
  const latlngs = points.map(p => [p.lat, p.lon]);
  map.fitBounds(L.latLngBounds(latlngs), { padding:[20,20] });
}
function sleep(ms){ return new Promise(res=>setTimeout(res, ms)); }
async function animate(points){
  const latlngs = [];
  for(const p of points){
    const ll = [p.lat, p.lon];
    latlngs.push(ll);
    pathLine.setLatLngs(latlngs);
    marker.setLatLng(ll);
    await sleep(180);
  }
}

document.getElementById('btnLoad').addEventListener('click', async ()=>{
  const fid = flightIdEl.value.trim();
  if(!fid){ alert('Enter a flight_id.'); return; }
  statusEl.textContent = 'Loading telemetry...';
  try{
    const pts = await fetchTelemetry(fid);
    kpiPoints.textContent = pts.length;
    saveRecent(fid, pts.length);
    if(!pts.length){ statusEl.textContent = 'No points yet. Add via Demo Stream or your connector.'; return; }
    fitPath(pts);
    await animate(pts);
    statusEl.textContent = `Rendered ${pts.length} points.`;
  }catch(e){
    console.error(e); statusEl.textContent = 'Load failed.';
  }
});

document.getElementById('btnDemo').addEventListener('click', async ()=>{
  const fid = flightIdEl.value.trim();
  if(!fid){ alert('Create or paste a flight_id first.'); return; }
  statusEl.textContent = 'Streaming demo telemetry...';
  try{
    let lat = 40.7, lon = -74.0, alt = 50;
    for(let k=0; k<60; k++){
      const pt = { flight_id: fid, k, lat, lon, alt, ts: new Date().toISOString() };
      await apiFetch('/telemetry', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(pt)});
      lat += 0.0025; lon += 0.0040; alt += (k%10===0? 10: 0);
      await sleep(140);
    }
    statusEl.textContent = 'Demo stream complete. Click "Load & Animate".';
  }catch(e){
    console.error(e); statusEl.textContent = 'Demo stream failed.';
  }
});

// Auto-ping on load
document.getElementById('btnPing').click();
</script>
</body>
</html>
